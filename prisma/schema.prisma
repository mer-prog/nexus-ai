generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// --- Organization ---

enum Plan {
  FREE
  PRO
  ENTERPRISE
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  plan      Plan     @default(FREE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users         User[]
  customers     Customer[]
  subscriptions Subscription[]
  invoices      Invoice[]
  activityLogs  ActivityLog[]

  @@map("organizations")
}

// --- User ---

enum Role {
  ADMIN
  MANAGER
  MEMBER
}

model User {
  id             String   @id @default(cuid())
  name           String
  email          String   @unique
  password       String
  role           Role     @default(MEMBER)
  organizationId String
  createdAt      DateTime @default(now())

  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  aiConversations AiConversation[]
  notifications   Notification[]
  activityLogs    ActivityLog[]

  @@index([organizationId])
  @@map("users")
}

// --- Customer ---

enum CustomerStatus {
  ACTIVE
  INACTIVE
  CHURNED
}

model Customer {
  id             String         @id @default(cuid())
  name           String
  email          String
  company        String?
  status         CustomerStatus @default(ACTIVE)
  organizationId String
  createdAt      DateTime       @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@map("customers")
}

// --- Subscription ---

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
}

model Subscription {
  id               String             @id @default(cuid())
  plan             Plan               @default(FREE)
  status           SubscriptionStatus @default(ACTIVE)
  currentPeriodEnd DateTime
  organizationId   String
  createdAt        DateTime           @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("subscriptions")
}

// --- Invoice ---

enum InvoiceStatus {
  PAID
  PENDING
  OVERDUE
}

model Invoice {
  id             String        @id @default(cuid())
  amount         Float
  status         InvoiceStatus @default(PENDING)
  issuedAt       DateTime      @default(now())
  paidAt         DateTime?
  organizationId String
  createdAt      DateTime      @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@map("invoices")
}

// --- AI Conversation ---

model AiConversation {
  id        String   @id @default(cuid())
  title     String
  userId    String
  createdAt DateTime @default(now())

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages AiMessage[]

  @@index([userId])
  @@map("ai_conversations")
}

// --- AI Message ---

enum MessageRole {
  USER
  ASSISTANT
}

model AiMessage {
  id             String      @id @default(cuid())
  role           MessageRole
  content        String
  conversationId String
  createdAt      DateTime    @default(now())

  conversation AiConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("ai_messages")
}

// --- Notification ---

model Notification {
  id        String   @id @default(cuid())
  title     String
  message   String
  read      Boolean  @default(false)
  userId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@map("notifications")
}

// --- Activity Log ---

model ActivityLog {
  id             String   @id @default(cuid())
  action         String
  details        String?
  userId         String
  organizationId String
  createdAt      DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@map("activity_logs")
}
